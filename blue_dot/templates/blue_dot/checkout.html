{% extends "blue_dot/base.html" %}
{% load static %}

{% block custom_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        z-index: 9999;
    }
</style>
{% endblock custom_css %}

{% block breadcrumb %}
<!-- breadcrumb area start -->
<section class="tp-breadcrumb-area tp-slider-spacing-inner p-relative z-index-1"
    style="{% if banner.background_image %}background-image: url('{{ banner.background_image.url }}');{% else %}background-image: url('{% static 'assets/img/breadcrumb/default-banner.jpg' %}');{% endif %}
    background-repeat: no-repeat;
    padding: 0px;
    height: 300px;
    background-position: center center;
    background-size: 100% 300px;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-xl-5 col-lg-6 col-md-8 col-12">
                <div class="tp-breadcrumb-content">
                    <h2 class="tp-breadcrumb-title tp-split-text right">{{ banner.title }}</h2>
                    <div class="tp-breadcrumb-body">
                        <a class="home" href="{% url 'home' %}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                            </svg>
                            Home
                        </a>
                        <span class="spacing">→</span>
                        <span class="current-page">{{ banner.subtitle }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- breadcrumb area end -->
{% endblock breadcrumb %}

{% block content %}
<!-- checkout area start -->
<section class="tp-checkout-area pt-120 pb-120">
    <div class="container">
        <form method="post" action="{% url 'cart_checkout' %}">
            {% csrf_token %}
            <div class="row">
                <div class="col-lg-7">
                    <div class="tp-checkout-bill-area">
                        <h3 class="tp-checkout-bill-title">Billing Details</h3>
                        <div class="tp-checkout-bill-form">
                            <div class="tp-checkout-bill-inner">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="tp-checkout-input">
                                            <label>Phone <span>*</span></label>
                                            <input type="text" name="phone" placeholder="Enter Your Phone Number">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="tp-checkout-input">
                                            <label>First Name <span>*</span></label>
                                            <input type="text" name="first_name" placeholder="First Name">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="tp-checkout-input">
                                            <label>Last Name <span>*</span></label>
                                            <input type="text" name="last_name" placeholder="Last Name">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="tp-checkout-input position-relative z-index-10">
                                            <label>District</label>
                                            <select name="district" id="district-select" class="form-control">
                                                <option value="">Select District</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="tp-checkout-input position-relative z-index-10">
                                            <label>Thana</label>
                                            <select name="thana" id="thana-select" class="form-control">
                                                <option value="">Select Thana</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="tp-checkout-input">
                                            <label>Address</label>
                                            <input type="text" name="address"
                                                placeholder="House number , street name, apartment, suite, unit, etc.">
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="tp-checkout-input">
                                            <label>Order notes (optional)</label>
                                            <textarea name="order_notes"
                                                placeholder="Notes about your order, e.g. special notes for delivery."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Order Summary -->
                <div class="col-lg-5">
                    <div class="tp-checkout-place">
                        <h3 class="tp-checkout-place-title">Your Order</h3>
                        <div class="tp-order-info-list">
                            <ul>
                                <li class="tp-order-info-list-header">
                                    <h4>Product</h4>
                                    <h4>Total</h4>
                                </li>
                                {% for data in cart_data %}
                                <li class="tp-order-info-list-desc">
                                    <p>{{ data.item.product.name }} <span>x {{ data.item.quantity }}</span></p>
                                    <span>৳{{ data.total_cost|floatformat:2 }}</span>
                                </li>
                                {% empty %}
                                <li class="tp-order-info-list-desc">
                                    <p>Your cart is empty.</p>
                                    <span>৳0.00</span>
                                </li>
                                {% endfor %}
                                <li class="tp-order-info-list-subtotal">
                                    <span>Subtotal</span>
                                    <span>৳{{ subtotal|floatformat:2 }}</span>
                                </li>
                                <li class="tp-order-info-list-shipping">
                                    <span>Shipping</span>
                                    <div class="tp-order-info-list-shipping-item d-flex flex-column align-items-end">
                                        <span>
                                            <input id="flat_rate" type="radio" name="shipping" value="100" checked>
                                            <label for="flat_rate">Flat rate: <span>৳ 100.00</span></label>
                                        </span>
                                        <span>
                                            <input id="free_shipping" type="radio" name="shipping" value="0">
                                            <label for="free_shipping">Free shipping</label>
                                        </span>
                                    </div>
                                </li>
                                <li class="tp-order-info-list-total">
                                    <span>Total</span>
                                    <span id="checkout-total">৳{{ subtotal|floatformat:2|add:"100.00" }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="tp-checkout-btn-wrapper">
                            <button type="submit" class="tp-btn theme-bg text-center w-100">
                                <span>Place Order</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>
<!-- checkout area end -->
{% endblock content %}

{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function () {
        const $districtSelect = $('#district-select');
        const $thanaSelect = $('#thana-select');

        // Load districts
        $.get("https://bdapi.vercel.app/api/v.1/district", function (data) {
            $districtSelect.append(data.data.map(d => `<option value="${d.id}-${d.name}">${d.name}</option>`));
        });

        // Load thanas based on district
        $districtSelect.on('change', function () {
            const fullValue = $(this).val(); // e.g., "15-Dhaka"
            const districtId = fullValue ? fullValue.split('-')[0] : ""; // extract only the ID
        
            $thanaSelect.html('<option value="">Loading...</option>');
            if (!districtId) return;
        
            $.get(`https://bdapi.vercel.app/api/v.1/upazilla/${districtId}`, function (data) {
                $thanaSelect.empty().append('<option value="">Select Thana</option>');
                data.data.forEach(thana => {
                    $thanaSelect.append(`<option value="${thana.id}-${thana.name}">${thana.name}</option>`);
                });
            });
        });
        

        // Initialize Select2
        $districtSelect.select2({ width: '100%' });
        $thanaSelect.select2({ width: '100%' });

        // Shipping Calculation
        const subtotal = parseFloat({{ subtotal|floatformat:"2" }});
        const totalElement = $('#checkout-total');

        function updateTotal() {
            const shippingCost = parseFloat($('input[name="shipping"]:checked').val()) || 0;
            const finalTotal = (subtotal + shippingCost).toFixed(2);
            totalElement.text(`৳${finalTotal}`);
        }

        $('input[name="shipping"]').on('change', updateTotal);
        updateTotal(); // Initialize
    });
</script>
{% endblock custom_js %}
