{% extends 'backend/base.html' %}
{% load static %}

{% block custom_css %}
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/datatables-rowgroup-bs5/rowgroup.bootstrap5.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/animate-css/animate.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/select2/select2.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/tagify/tagify.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/@form-validation/form-validation.css' %}" />
  <link rel="stylesheet" href="{% static 'assets/vendor/libs/bs-stepper/bs-stepper.css' %}" />

 <style>
        .icon-park--edit-two {
            display: inline-block;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cg fill='none' stroke='%230e65c1' stroke-linejoin='round' stroke-width='4'%3E%3Cpath stroke-linecap='round' d='M42 26V40C42 41.1046 41.1046 42 40 42H8C6.89543 42 6 41.1046 6 40V8C6 6.89543 6.89543 6 8 6L22 6'/%3E%3Cpath fill='%232167d7' d='M14 26.7199V34H21.3172L42 13.3081L34.6951 6L14 26.7199Z'/%3E%3C/g%3E%3C/svg%3E");
            transition: 0.3s linear;
        }

        .icon-park--edit-two:hover {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cg fill='none' stroke='%230d82fd' stroke-linejoin='round' stroke-width='4'%3E%3Cpath stroke-linecap='round' d='M42 26V40C42 41.1046 41.1046 42 40 42H8C6.89543 42 6 41.1046 6 40V8C6 6.89543 6.89543 6 8 6L22 6'/%3E%3Cpath fill='%23448cff' d='M14 26.7199V34H21.3172L42 13.3081L34.6951 6L14 26.7199Z'/%3E%3C/g%3E%3C/svg%3E");
        }

        .weui--delete-filled {
            display: inline-block;
            width: 30px;
            height: 30px;
            cursor: pointer;
            background-repeat: no-repeat;
            background-size: 100% 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23b91c1c' fill-rule='evenodd' d='m18.412 6.5l-.801 13.617A2 2 0 0 1 15.614 22H8.386a2 2 0 0 1-1.997-1.883L5.59 6.5H3.5v-1A.5.5 0 0 1 4 5h16a.5.5 0 0 1 .5.5v1zM10 2.5h4a.5.5 0 0 1 .5.5v1h-5V3a.5.5 0 0 1 .5-.5M9 9l.5 9H11l-.4-9zm4.5 0l-.5 9h1.5l.5-9z' stroke-width='0.5' stroke='%23b91c1c'/%3E%3C/svg%3E");
            transition: 0.3s linear;
        }

        .weui--delete-filled:hover{
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23ec0808' fill-rule='evenodd' d='m18.412 6.5l-.801 13.617A2 2 0 0 1 15.614 22H8.386a2 2 0 0 1-1.997-1.883L5.59 6.5H3.5v-1A.5.5 0 0 1 4 5h16a.5.5 0 0 1 .5.5v1zM10 2.5h4a.5.5 0 0 1 .5.5v1h-5V3a.5.5 0 0 1 .5-.5M9 9l.5 9H11l-.4-9zm4.5 0l-.5 9h1.5l.5-9z' stroke-width='0.5' stroke='%23ec0808'/%3E%3C/svg%3E");
        }

    </style>
{% endblock %}

{% block content %}
  <!-- DataTable with Buttons -->
  <div class="card">
    <div class="card-datatable text-nowrap">
      <div id="DataTables_Table_0_wrapper" class="dt-container dt-bootstrap5 dt-empty-footer">
        <div class="row card-header mx-0 px-2">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto">
            <h5 class="card-title mb-0 text-md-start text-center">Brand Management</h5>
          </div>
          <div class="d-md-flex justify-content-between align-items-center dt-layout-end col-md-auto mt-0">
            <div class="dt-buttons btn-group flex-wrap">
              <div class="btn-group">
                <button class="btn buttons-collection btn-label-primary dropdown-toggle me-4 waves-effect border-none" tabindex="0" aria-controls="DataTables_Table_0" type="button" aria-haspopup="dialog" aria-expanded="false">
                  <span><span class="d-flex align-items-center gap-2"><i class="icon-base ri ri-external-link-line icon-18px"></i> <span class="d-none d-sm-inline-block">Export</span></span></span>
                </button>
                <button class="btn create-new btn-primary" id="createBrandBtn" tabindex="0" aria-controls="DataTables_Table_0" type="button">
                  <span><span class="d-flex align-items-center"><i class="icon-base ri ri-add-line icon-18px me-sm-1"></i><span class="d-none d-sm-inline-block">Add New Brand</span></span></span>
                </button>
              </div> 
            </div>
          </div>
        </div>
        <div class="row m-3 mx-2 my-0 justify-content-between">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto">
            <div class="dt-length">
              <label for="dt-length-0">
                Show<select name="DataTables_Table_0_length" aria-controls="DataTables_Table_0" class="form-select form-select-sm" id="dt-length-0">
                  <option value="7">7</option>
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>entries
              </label>
            </div>
          </div>
          <div class="d-md-flex justify-content-between align-items-center dt-layout-end col-md-auto mt-0">
            <div class="dt-search mt-md-5 mt-0">
              <label for="dt-search-0">Search:</label>
              <input type="search" class="form-control form-control-sm" id="dt-search-0" placeholder="Search brands..." aria-controls="DataTables_Table_0" />
            </div>
          </div>
        </div>
        <div class="justify-content-between dt-layout-table">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive">
            <div id="successMessage" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1050; width: auto; max-width: 600px;" class="alert alert-success" role="alert"></div>

            <table class="datatables-basic table table-bordered table-responsive dataTable dtr-column" id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">
              <colgroup>
                <col data-dt-column="0" />
                <col data-dt-column="1" />
                <col data-dt-column="2" />
                <col data-dt-column="3" />
                <col data-dt-column="4" />
              </colgroup>
              <thead>
                <tr>
                  <th data-dt-column="0" rowspan="1" colspan="1" class="dt-orderable-asc dt-orderable-desc" aria-label="ID: Activate to sort" tabindex="0">
                    <span class="dt-column-title" role="button">S/L</span><span class="dt-column-order"></span>
                  </th>
                  <th data-dt-column="1" rowspan="1" colspan="1" class="dt-orderable-asc dt-orderable-desc" aria-label="Name: Activate to sort" tabindex="0">
                    <span class="dt-column-title" role="button">Brand Name</span><span class="dt-column-order"></span>
                  </th>
                  <th data-dt-column="2" rowspan="1" colspan="1" class="dt-orderable-asc dt-orderable-desc" aria-label="Image: Activate to sort" tabindex="0">
                    <span class="dt-column-title" role="button">Image</span><span class="dt-column-order"></span>
                  </th>
                  <th data-dt-column="3" rowspan="1" colspan="1" class="dt-orderable-asc dt-orderable-desc" aria-label="Status: Activate to sort" tabindex="0">
                    <span class="dt-column-title" role="button">Status</span><span class="dt-column-order"></span>
                  </th>
                  <th class="dt-orderable-none" data-dt-column="4" rowspan="1" colspan="1" aria-label="Actions">
                    <span class="dt-column-title">Actions</span><span class="dt-column-order"></span>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for brand in brands %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ brand.name|default:"Unnamed Brand" }}</td>
                  <td>
                    {% if brand.image %}
                      <img src="{{ brand.image }}" alt="{{ brand.name }}" style="max-height: 50px; max-width: 100px;">
                    {% else %}
                      No Image
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-{% if brand.status == 1 %}label-success{% else %}label-danger{% endif %}">
                      {{ brand.get_status_display }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex">
                      <span class="icon-park--edit-two me-2" 
                            data-bs-toggle="modal" 
                            data-bs-target="#editBrandModal"
                            data-brand-id="{{ brand.id }}"
                            data-brand-name="{{ brand.name }}"
                            data-brand-image="{{ brand.image }}"
                            data-brand-status="{{ brand.status }}"></span>
                      <span class="weui--delete-filled" 
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteBrandModal"
                            data-brand-id="{{ brand.id }}"></span>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot></tfoot>
            </table>
          </div>
        </div>
        <div class="row mx-3 justify-content-between">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto">
            <div class="dt-info" aria-live="polite" id="DataTables_Table_0_info" role="status">
              Showing {{ brands.start_index }} to {{ brands.end_index }} of {{ brands.paginator.count }} entries
            </div>
          </div>
          <div class="d-md-flex justify-content-between align-items-center dt-layout-end col-md-auto mt-0">
            <div class="dt-paging">
              <nav aria-label="pagination">
                <ul class="pagination">
                  {% if brands.has_previous %}
                    <li class="page-item first">
                      <a class="page-link" href="?page=1"><i class="ti ti-chevrons-left ti-xs"></i></a>
                    </li>
                    <li class="page-item prev">
                      <a class="page-link" href="?page={{ brands.previous_page_number }}"><i class="ti ti-chevron-left ti-xs"></i></a>
                    </li>
                  {% endif %}
                  
                  {% for num in brands.paginator.page_range %}
                    {% if brands.number == num %}
                      <li class="page-item active">
                        <a class="page-link" href="#">{{ num }}</a>
                      </li>
                    {% elif num > brands.number|add:'-3' and num < brands.number|add:'3' %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}
                  
                  {% if brands.has_next %}
                    <li class="page-item next">
                      <a class="page-link" href="?page={{ brands.next_page_number }}"><i class="ti ti-chevron-right ti-xs"></i></a>
                    </li>
                    <li class="page-item last">
                      <a class="page-link" href="?page={{ brands.paginator.num_pages }}"><i class="ti ti-chevrons-right ti-xs"></i></a>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- / DataTable with Buttons -->

  <!-- Create Brand Modal -->
  <div class="modal fade" id="createBrandModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-simple modal-edit-user">
      <div class="modal-content">
        <div class="modal-body p-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center mb-6">
            <h4 class="mb-2">Create New Brand</h4>
            <p class="mb-6">Add a new brand to your system</p>
          </div>
          <form id="createBrandForm" class="row g-5" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                <input type="text" id="brandName" name="name" class="form-control" placeholder="Enter brand name" required />
                <label for="brandName">Brand Name</label>
              </div>
            </div>
            
            <div class="col-12">
              <div class="image-upload-wrapper">
                <div class="form-floating form-floating-outline">
                  <input type="file" id="brandImage" name="image" class="image-upload-input" accept="image/*" />
                  <label for="brandImage" class="image-upload-label">
                    <i class="ti ti-upload me-2"></i>Click to upload brand image
                  </label>
                </div>
                <div class="image-preview-container">
                  <img id="createImagePreview" class="image-preview" src="#" alt="Image preview" />
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                <select id="brandStatus" name="status" class="form-select">
                  <option value="1" selected>Active</option>
                  <option value="0">Inactive</option>
                </select>
                <label for="brandStatus">Status</label>
              </div>
            </div>
            
            <div class="col-12 text-center">
              <button type="submit" class="btn btn-primary me-3">Create Brand</button>
              <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Brand Modal -->
  <div class="modal fade" id="editBrandModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-simple modal-edit-user">
      <div class="modal-content">
        <div class="modal-body p-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center mb-6">
            <h4 class="mb-2">Edit Brand Information</h4>
            <p class="mb-6">Update brand details as needed</p>
          </div>
          <form id="editBrandForm" class="row g-5" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" id="editBrandId" name="id" />
            
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                <input type="text" id="editBrandName" name="name" class="form-control" placeholder="Enter brand name" required />
                <label for="editBrandName">Brand Name</label>
              </div>
            </div>
            
            <div class="col-12">
              <div class="image-upload-wrapper">
                <div class="form-floating form-floating-outline">
                  <input type="file" id="editBrandImage" name="image" class="image-upload-input" accept="image/*" />
                  <label for="editBrandImage" class="image-upload-label">
                    <i class="ti ti-upload me-2"></i>Click to change brand image
                  </label>
                </div>
                <div class="image-preview-container">
                  <img id="editImagePreview" class="image-preview" src="#" alt="Current image" />
                  <input type="hidden" id="currentImage" name="current_image" value="" />
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="form-floating form-floating-outline">
                <select id="editBrandStatus" name="status" class="form-select">
                  <option value="1">Active</option>
                  <option value="0">Inactive</option>
                </select>
                <label for="editBrandStatus">Status</label>
              </div>
            </div>
            
            <div class="col-12 text-center">
              <button type="submit" class="btn btn-primary me-3">Update Brand</button>
              <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Brand Modal -->
  <div class="modal fade" id="deleteBrandModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-simple modal-edit-user">
      <div class="modal-content">
        <div class="modal-body">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          <div class="text-center mb-4">
            <h3 class="mb-2">Delete Brand</h3>
            <p class="text-muted">Are you sure you want to delete this brand?</p>
          </div>
          <form id="deleteBrandForm">
            {% csrf_token %}
            <input type="hidden" id="deleteBrandId" name="id" />
            <div class="col-12 text-center">
              <button type="submit" class="btn btn-danger me-3">Delete</button>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Close">
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!--/ Delete Brand Modal -->
{% endblock %}

{% block custom_js %}
  <script src="{% static 'assets/js/tables-datatables-basic.js' %}"></script>
  <!-- Flat Picker -->
  <script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
  <script src="{% static 'assets/vendor/libs/flatpickr/flatpickr.js' %}"></script>
  <script src="{% static 'assets/js/ui-modals.js' %}"></script>
  
 <script>
  $(document).ready(function () {
    // Setup CSRF token for AJAX
    function getCSRFToken() {
      return $('input[name="csrfmiddlewaretoken"]').val();
    }

    // Show create modal
    $('#createBrandBtn').click(function () {
      $('#createBrandModal').modal('show');
    });

    // Show edit modal and fill data
    $('.icon-park--edit-two').click(function () {
      const brandId = $(this).data('brand-id');
      const brandName = $(this).data('brand-name');
      const brandImage = $(this).data('brand-image');
      const brandStatus = $(this).data('brand-status');

      $('#editBrandId').val(brandId);
      $('#editBrandName').val(brandName);
      $('#editBrandImage').val(brandImage);
      $('#editBrandStatus').val(brandStatus);

      $('#editBrandModal').modal('show');
    });

    // Show delete modal
    $('.weui--delete-filled').click(function () {
      const brandId = $(this).data('brand-id');
      $('#deleteBrandId').val(brandId);
      $('#deleteBrandModal').modal('show');
    });

    // Create Brand
    $('#createBrandForm').submit(function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      $.ajax({
        url: '{% url "brand_create" %}',
        type: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          $('#createBrandModal').modal('hide');
          toastr.success('Brand created successfully');
          location.reload();
        },
        error: function () {
          toastr.error('Failed to create brand');
        }
      });
    });

    // Edit Brand
    $('#editBrandForm').submit(function (e) {
      e.preventDefault();
      const brandId = $('#editBrandId').val();
      const formData = new FormData(this);

      $.ajax({
        url: `/admin-dashboard/brands/edit/${brandId}/`,
        type: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          $('#editBrandModal').modal('hide');
          toastr.success('Brand updated successfully');
          location.reload();
        },
        error: function () {
          toastr.error('Failed to update brand');
        }
      });
    });

    // Delete Brand
    $('#deleteBrandForm').submit(function (e) {
      e.preventDefault();
      const brandId = $('#deleteBrandId').val();

      $.ajax({
        url: `/admin-dashboard/brands/delete/${brandId}/`,
        type: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        success: function (response) {
          $('#deleteBrandModal').modal('hide');
          toastr.success('Brand deleted successfully');
          location.reload();
        },
        error: function () {
          toastr.error('Failed to delete brand');
        }
      });
    });
  });
</script>
{% endblock %}