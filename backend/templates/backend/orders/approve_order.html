{% extends 'backend/base.html' %}
{% load static %}

{% block custom_css %}
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/datatables-rowgroup-bs5/rowgroup.bootstrap5.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/maxLength/maxLength.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/flatpickr/flatpickr.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/select2/select2.css' %}" />

    <link rel="stylesheet" href="{% static 'assets/vendor/libs/quill/typography.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/highlight/highlight.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/quill/katex.css' %}" />
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/quill/editor.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">


<style>
    
    
    .table thead th {
        vertical-align: middle;
        text-align: start;
    }
    
    .quantity-input {
        width: 80px;
        display: inline-block;
    }

    tbody tr td input{
        height: 20px !important;
    }

    tbody tr td select{
        height: 33px;
        padding: 5px 15px !important;
    }
    
    .selected-items {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        padding: 1.25rem;
        background-color: #f8f9fc;
    }
    
    #selectedItemsTable tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .remove-btn {
        color: #e74a3b;
        cursor: pointer;
    }
    
    .remove-btn:hover {
        color: #be2617;
    }
</style>
    
{% endblock %}

{% block content %}
    <div class="row gy-6">
        
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Create New Order</h6>
                </div>
                {% if messages %}
                    <div>
                        {% for message in messages %}
                        <div class="alert 
                            {% if message.tags == 'error' %}alert-danger
                            {% elif message.tags == 'success' %}alert-success
                            {% elif message.tags == 'warning' %}alert-warning
                            {% else %}alert-info{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <div class="card-body">
                    <h2 class="card-header" style="border-bottom: 1px solid #d5d5d5; margin-bottom: 50px;">Create a New Order</h2>
                    <form id="orderForm" method="POST">
                        {% csrf_token %}
                        <div class="row g-6">
                            <div class="col-md-6">
                                <div class="form-floating form-floating-outline">
                                    <select id="customer" class="select2 form-select" name="customer" data-allow-clear="true">
                                        <option value="">Select Customer</option>
                                        {% for customer in customers %}
                                            <option value="{{ customer.id }}">{{ customer.CustomerName }} - </option>
                                        {% endfor %}
                                    </select>
                                    <label for="multicol-country">Customer</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating form-floating-outline">
                                    <select id="productSelector" class="select2 form-select" name="customer" data-allow-clear="true">
                                        <option value="">Select Product</option>
                                        {% for item in order_items %}
                                            <option value="{{ item.id }}">{{ item.product.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <label for="productSelector">Customer</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Materials Table -->
                        <div class="table-responsive mt-4">
                            <table class="table table-bordered table-hover" id="materialsTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="2%">#</th>
                                        <th width="25%">Material</th>
                                        <th width="15%">Unit</th>
                                        <th width="15%">Available</th>
                                        <th width="15%">Quantity</th>
                                        <th width="15%">Price</th>
                                        <th width="10%">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for material in materials %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ material.mr_material_name }}</td>
                                        <td>
                                            <select class="form-control unit-select" data-material="{{ material.id }}">
                                                {% for unit in units %}
                                                <option value="{{ unit.id }}">{{ unit.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="available-qty">{{ material.quantity }}</td>
                                        <td>
                                            <input type="number" min="1" class="form-control quantity-input" 
                                                   data-material="{{ material.id }}" 
                                                   data-price="{{ material.mr_sell_price }}"
                                                   placeholder="Qty">
                                        </td>
                                        <td class="price">${{ material.mr_sell_price }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary add-btn" 
                                                    data-material="{{ material.id }}">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Selected Items Table -->
                        {% comment %} <div class="selected-items mt-4">
                            <h5 class="mb-3">Selected Materials</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="selectedItemsTable">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Material</th>
                                            <th>Unit</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Selected items will appear here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4" class="text-right"><strong>Grand Total</strong></td>
                                            <td id="grandTotal">$0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div> {% endcomment %}

                        {% for item in order_items %}
                            <div class="selected-items mt-4" id="selected-materials-{{ item.id }}">
                                <h5 class="mb-3">Materials for: {{ item.product.name }}</h5>
                                <div class="table-responsive">
                                    <table class="table selectedMaterialsTable" id="selected-materials-{{ item.id }}" data-product-id="{{ item.id }}">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Material</th>
                                                <th>Unit</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Total</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" class="text-right"><strong>Total for this product:</strong></td>
                                                <td class="product-total" id="product-total-{{ item.id }}" style="font-weight: 600;">$0.00</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="mt-4 text-end pe-12">
                            <h5><strong>Grand Total:</strong> <span id="grandTotalAll">$0.00</span></h5>
                        </div>
                        <!-- Submit Button -->
                        <div class="form-group row mt-4">
                            <div class="col-sm-10 offset-sm-2">
                                <button type="submit" class="btn btn-primary">Create Order</button>
                                <a href="{% url 'order_list' %}" class="btn btn-secondary">Cancel</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/35.3.0/classic/ckeditor.js"></script>
<!-- Vendors JS -->
<script src="{% static 'assets/vendor/libs/cleave-zen/cleave-zen.js' %}"></script>
<script src="{% static 'assets/vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'assets/vendor/libs/flatpickr/flatpickr.js' %}"></script>
<script src="{% static 'assets/vendor/libs/select2/select2.js' %}"></script>
<script src="https://cdn.ckeditor.com/4.21.0/standard/ckeditor.js"></script>

<script src="{% static 'assets/vendor/libs/quill/katex.js' %}"></script>
<script src="{% static 'assets//vendor/libs/highlight/highlight.js' %}"></script>
<script src="{% static 'assets/vendor/libs/quill/quill.js' %}"></script>

<script src="{% static 'assets/js/form-layouts.js' %}"></script>
<script src="{% static 'assets/js/forms-editors.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>


<script>
$(document).ready(function() {
    // Initialize Select2 for customer dropdown
    $('.select2').select2();
    
    // Add material to selected items
    $('.add-btn').click(function () {
        const selectedProductId = $('#productSelector').val();
        if (!selectedProductId) {
            alert('Please select a product first.');
            return;
        }

        const materialId = $(this).data('material');
        const row = $(this).closest('tr');
        const quantity = row.find('.quantity-input').val();
        const unitId = row.find('.unit-select').val();
        const unitText = row.find('.unit-select option:selected').text();
        const materialName = row.find('td:eq(1)').text();
        const price = parseFloat(row.find('.price').text().replace('$', ''));

        if (!quantity || quantity <= 0) {
            alert('Please enter a valid quantity');
            return;
        }

        const tableBody = $(`#selected-materials-${selectedProductId} table tbody`);
        
        // Check for duplicate
        if (tableBody.find(`tr[data-material="${materialId}"]`).length > 0) {
            alert('This material is already added to the selected product');
            return;
        }

        const total = price * quantity;

        tableBody.append(`
            <tr data-material="${materialId}">
                <td>${materialName}</td>
                <td>${unitText}</td>
                <td>${quantity}</td>
                <td>$${price.toFixed(2)}</td>
                <td>$${total.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
                <input type="hidden" name="product_materials[${selectedProductId}][]" value="${materialId}">
                <input type="hidden" name="product_units[${selectedProductId}][]" value="${unitId}">
                <input type="hidden" name="product_quantities[${selectedProductId}][]" value="${quantity}">
            </tr>
        `);

        $(`#selected-materials-${selectedProductId}`).show();

        updateProductTotal(selectedProductId);
        updateGrandTotal();
    });

    function updateProductTotal(productId) {
        let total = 0;
        $(`#selected-materials-${productId} tbody tr`).each(function () {
            const rowTotal = parseFloat($(this).find('td:eq(4)').text().replace('$', '')) || 0;
            total += rowTotal;
        });
        $(`#product-total-${productId}`).text('$' + total.toFixed(2));
    }

    function updateGrandTotal() {
        let grandTotal = 0;
        $('.product-total').each(function () {
            const productTotal = parseFloat($(this).text().replace('$', '')) || 0;
            grandTotal += productTotal;
        });
        $('#grandTotalAll').text('$' + grandTotal.toFixed(2));
    }

    $('#productSelector').change(function () {
        //$('.selected-items').hide(); // Hide all
        const productId = $(this).val();
        if (productId) {
            $(`#selected-materials-${productId}`).show(); // Show selected
        }
    });
    
    // Remove material from selected items
    $(document).on('click', '.remove-btn', function () {
        const row = $(this).closest('tr');
        const productId = $(this).closest('table').data('product-id');
        row.remove();
        updateProductTotal(productId);
        updateGrandTotal();
    });
    
    // Update grand total function
    function updateGrandTotal() {
        let grandTotal = 0;
        $('.product-total').each(function () {
            const productTotal = parseFloat($(this).text().replace('$', '')) || 0;
            grandTotal += productTotal;
        });
        $('#grandTotalAll').text('$' + grandTotal.toFixed(2));
    }
    
    // Form submission
    $('#orderForm').submit(function (e) {
        const anyRows = $('.selectedMaterialsTable tbody tr').length;
        if (!anyRows) {
            e.preventDefault();
            alert('Please add at least one material to a product before submitting.');
        }
    });
});
</script>
{% endblock %}
